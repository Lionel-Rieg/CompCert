CFILES=main.c solver.c clock.c
GCDAFILES=$(CFILES:.c=.gcda)
CCOMP=../../../ccomp
GCC=k1-cos-gcc
LIBS=-lm
PROFILING_DAT=compcert_profiling.dat
EXECUTE=k1-cluster --
EXAMPLE=sudoku.sat

ALL=minisat.ccomp minisat.branch_linearize minisat.profiled minisat.gcc-O3 minisat.gcc-O3.profiled minisat.gcc-O3.profile-arcs minisat.profile-arcs

all: $(ALL)

minisat.ccomp: $(CFILES)
	$(CCOMP) $(CCOMPFLAGS) $(CFILES) -o $@ $(LIBS)

minisat.profile-arcs: $(CFILES)
	$(CCOMP) $(CCOMPFLAGS) -fprofile-arcs $(CFILES) -o $@ $(LIBS)

minisat.gcc-O3: $(CFILES)
	$(GCC) $(GCCFLAGS) -O3 $(CFILES) -o $@ $(LIBS)

minisat.gcc-O3.profile-arcs: $(CFILES)
	$(GCC) $(GCCFLAGS) -fprofile-arcs -O3 $(CFILES) -o $@ $(LIBS)

gcda: minisat.gcc-O3.profile-arcs
	$(EXECUTE) $< $(EXAMPLE)

$(GCDAFILES): gcda

minisat.gcc-O3.profiled: $(CFILES) $(GCDAFILES)
	$(GCC) $(GCCFLAGS) -O3 -fprofile-use $(CFILES) -o $@ $(LIBS)

minisat.branch_linearize: $(CFILES)
	$(CCOMP) $(CCOMPFLAGS) -ftracelinearize $(CFILES) -o $@ $(LIBS)

$(PROFILING_DAT): minisat.profile-arcs
	-rm -f $(PROFILING_DAT)
	$(EXECUTE) $< $(EXAMPLE)

minisat.profiled: $(CFILES) $(PROFILING_DAT)
	$(CCOMP) $(CCOMPFLAGS) -fprofile-use= $(PROFILING_DAT) -fbranchlinearize $(CFILES) -o $@ $(LIBS)

clean:
	-rm -f $(ALL) $(PROFILING_DAT) $(GCDAFILES)

.PHONY: clean gcda
